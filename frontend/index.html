<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sample</title>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>

<body x-data="dashboard()">

<header class="container" x-data="{ open: false }">
  <nav style="display: flex; justify-content: space-between; align-items: center; position: relative;">
    <h3>Sample</h3>
    <h3 @click="open = !open" style="cursor: pointer; user-select: none;">Menu ▾</h3>
    <ul x-show="open" 
        x-transition 
        @click.outside="open = false"
        style="
          position: absolute;
          top: 100%;
          right: 0;
          background: #ffffff;
          border-radius: 0.25rem;
          padding: 0.5rem 0;
          display: flex;
          flex-direction: column;
          box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
          z-index: 1000;
          text-align: left;
        ">
      <li><a href="#">Profile</a></li>
      <li><a href="#">Settings</a></li>
      <li><a href="#">Help</a></li>
      <li><a href="#" @click.prevent="logout">Logout</a></li>
    </ul>
  </nav>
</header>

<!-- ✅ MAIN CONTENT -->
<main>
  <p>Your successful login fetched a JWT from AWS Cognito and placed it in local storage</p>
  <p>The JWT was used in the fetch() authorization header to connect to the API Gateway route https://api.edgar.oddball.io/message/2 which is protected by an authorizor.</p>
  <p>The API call was routed through a public CORS proxy to circumvent still-unsolved CORS issues. This should not be used in a production setting.</p>

<!--
  <article>
    <h3>Your JWT (IdToken):</h3>
    <pre x-text="token"></pre>
  </article>
-->

  <article style="margin-top: 2rem;">
    <strong>API Response:</strong>
    <pre x-text="apiResponse"></pre>
  </article>

</main>

<script>
  function dashboard() {
    return {
      token: '',

      init() {
        const storedToken = localStorage.getItem('idToken');
        if (!storedToken) {
          // No token? send user back to login
          window.location.href = 'login.html';
        } else {
          this.token = storedToken;
          this.fetchData();
        }
      },

      async fetchData() {
        this.loading = true;
        this.apiResponse = '';
        try {
          const response = await fetch('https://test.cors.workers.dev/?https://api.edgar.oddball.io/message/2', {
            method: 'GET',
            headers: {
              'Authorization': 'Bearer ' + this.token,
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          this.apiResponse = JSON.stringify(data, null, 2);
        } catch (err) {
          this.apiResponse = `Error: ${err.message}`;
        } finally {
          this.loading = false;
        }
      },

      logout() {
        localStorage.removeItem('idToken');
        window.location.href = 'login.html';
      }
    }
  }
</script>

</body>
</html>
